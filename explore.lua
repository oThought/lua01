-- What the Player can see
Mist = {{"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"}}

-- The World Map
Real = {{"[D]", "[V]", "[D]", "[D]", "[D]", "[R]", "[ ]", "[ ]", "[T]", "[ ]", "[T]", "[ ]", "[B]", "[W]", "[W]", "[K]", "[W]", "[W]", "[W]", "[W]"},
        {"[D]", "[D]", "[D]", "[ ]", "[ ]", "[ ]", "[R]", "[ ]", "[T]", "[ ]", "[T]", "[ ]", "[ ]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[W]", "[ ]"},
        {"[A]", "[D]", "[ ]", "[ ]", "[ ]", "[ ]", "[R]", "[ ]", "[T]", "[ ]", "[T]", "[ ]", "[ ]", "[L]", "[ ]", "[W]", "[W]", "[W]", "[B]", "[ ]"},
        {"[D]", "[D]", "[ ]", "[N]", "[ ]", "[ ]", "[ ]", "[E]", "[ ]", "[ ]", "[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[W]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[D]", "[ ]", "[N]", "[N]", "[N]", "[ ]", "[ ]", "[T]", "[R]", "[ ]", "[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[B]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[D]", "[ ]", "[ ]", "[N]", "[ ]", "[ ]", "[T]", "[ ]", "[R]", "[ ]", "[T]", "[C]", "[C]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[T]", "[ ]", "[R]", "[ ]", "[T]", "[C]", "[C]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[T]", "[ ]", "[ ]", "[ ]", "[R]", "[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[F]", "[F]", "[ ]", "[ ]", "[ ]"},
        {"[ ]", "[ ]", "[ ]", "[T]", "[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[T]", "[ ]", "[ ]", "[F]", "[F]", "[F]", "[F]", "[F]", "[ ]"},
        {"[ ]", "[T]", "[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[T]", "[ ]", "[F]", "[F]", "[M]", "[F]", "[F]", "[F]", "[F]"},
        {"[T]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[L]", "[ ]", "[ ]", "[ ]", "[T]", "[F]", "[F]", "[M]", "[P]", "[M]", "[F]", "[F]", "[ ]"},
        {"[B]", "[ ]", "[H]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[W]", "[B]", "[ ]", "[ ]", "[T]", "[F]", "[F]", "[M]", "[F]", "[F]", "[ ]", "[ ]"},
        {"[W]", "[ ]", "[H]", "[H]", "[ ]", "[ ]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[B]", "[T]", "[ ]", "[F]", "[F]", "[F]", "[ ]", "[ ]", "[ ]"},
        {"[W]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[W]", "[ ]", "[T]", "[F]", "[F]", "[F]", "[ ]", "[ ]", "[ ]"},
        {"[W]", "[W]", "[ ]", "[ ]", "[ ]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[T]", "[ ]", "[F]", "[ ]", "[ ]", "[ ]", "[ ]"},
        {"[K]", "[W]", "[B]", "[ ]", "[B]", "[W]", "[W]", "[W]", "[W]", "[K]", "[W]", "[W]", "[W]", "[W]", "[T]", "[F]", "[ ]", "[ ]", "[O]", "[O]"},
        {"[W]", "[W]", "[W]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[ ]", "[T]", "[ ]", "[ ]", "[O]", "[O]"},
        {"[W]", "[W]", "[W]", "[ ]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[ ]", "[T]", "[ ]", "[ ]", "[ ]"},
        {"[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[ ]", "[T]", "[ ]", "[ ]"},
        {"[S]", "[W]", "[W]", "[W]", "[W]", "[W]", "[W]", "[S]", "[W]", "[W]", "[W]", "[W]", "[W]", "[S]", "[W]", "[W]", "[W]", "[W]", "[B]", "[ ]"}}

-- Prints the grid
function printGrid(grid)
    io.write("     1     2     3     4     5     6     7     8     9    10    11    12    13    14    15    16    17    18    19    20")
    io.write("\n")
    io.write("  /-----------------------------------------------------------------------------------------------------------------------\\")
    for i = 1, 20 do
        io.write("\n")  
        io.write(i)
        if i <= 9 then io.write(" ") end
        io.write("| ")
        for j = 1, 20 do
            io.write(grid[i][j] .. " | ")
        end
        io.write(i)
        io.write("\n") 
        if i ~= 20 then
            io.write("  |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|")
        end
    end
    io.write("  \\-----------------------------------------------------------------------------------------------------------------------/")
    io.write("\n")
    io.write("     1     2     3     4     5     6     7     8     9    10    11    12    13    14    15    16    17    18    19    20")
    io.write("\n")
end

function printInventory(inventory, keys)
    for _, key in ipairs(keys) do
        print(key .. ": " .. tostring(inventory[key]))
    end
end

local function containsKey(table, key)
    for k, _ in pairs(table) do
        if k == key then
            return true
        end
    end
    return false
end

-- Creates a copy which doesn't affect the original
function deepcopy(orig)
    local copies = {} 
    local function _deepcopy(orig)
        if type(orig) ~= 'table' then
            return orig
        end
        if copies[orig] then
            return copies[orig]
        end
        local copy = {}
        copies[orig] = copy
        for k, v in next, orig, nil do
            copy[_deepcopy(k)] = _deepcopy(v)
        end
        setmetatable(copy, _deepcopy(getmetatable(orig)))
        return copy
    end
    return _deepcopy(orig)
end

function countOccurrencesList(list, target)
    local count = 0
    for i = 1, #list do
        if list[i] == target then
            count = count + 1
        end
    end
    return count
end

-- Reveals the board when the player moves
function revealGrid(mistMap, realMap, posX, posY)
    local clone = deepcopy(mistMap)
    local playerX = deepcopy(posX)
    local playerY = deepcopy(posY)
    -- Fog Generation
    for i = 1, 20 do
        for j = 1, 20 do
            if clone[i][j] == "[ ]" then clone[i][j] = "{▉}" end
        end
    end
    -- Edge Detection
    if spyglass then
        if playerX <= 3 then playerX = 4 end
        if playerY <= 3 then playerY = 4 end
        if playerX >= 18 then playerX = 17 end
        if playerY >= 18 then playerY = 17 end
        if playerY == 17 and playerX == 17 then 
            clone[20][20], clone[18][20], clone[19][20], clone[20][19], clone[20][18] = realMap[20][20], realMap[18][20], realMap[19][20], realMap[20][19], realMap[20][18]
        end
        if playerY == 17 and playerX == 4 then 
            clone[20][1], clone[20][2], clone[20][3], clone[19][1], clone[18][2] = realMap[20][1], realMap[20][2], realMap[20][3], realMap[19][1], realMap[18][1]
        end
        if playerY == 4 and playerX == 17 then 
            clone[1][20], clone[2][20], clone[3][20], clone[1][19], clone[1][18] = realMap[1][20], realMap[2][20], realMap[3][20], realMap[1][19], realMap[1][18]
        end
        if playerY == 4 and playerX == 4 then 
            clone[1][1], clone[1][2], clone[1][3], clone[2][1], clone[3][1] = realMap[1][1], realMap[1][2], realMap[1][3], realMap[2][1], realMap[3][1]
        end
    else
        if playerX <= 2 then playerX = 3 end
        if playerY <= 2 then playerY = 3 end
        if playerX >= 19 then playerX = 18 end
        if playerY >= 19 then playerY = 18 end
        if playerY == 18 and playerX == 18 then clone[20][20] = realMap[20][20] end
        if playerY == 18 and playerX == 3 then clone[20][1] = realMap[20][1] end
        if playerY == 3 and playerX == 18 then clone[1][20] = realMap[1][20] end
        if playerY == 3 and playerX == 3 then clone[1][1] = realMap[1][1] end
    end
    -- Clears the Fog
    clone[playerY-2][playerX-1], clone[playerY-2][playerX], clone[playerY-2][playerX+1] = realMap[playerY-2][playerX-1], realMap[playerY-2][playerX], realMap[playerY-2][playerX+1]
    clone[playerY-1][playerX-2], clone[playerY-1][playerX-1], clone[playerY-1][playerX], clone[playerY-1][playerX+1], clone[playerY-1][playerX+2] = realMap[playerY-1][playerX-2], realMap[playerY-1][playerX-1], realMap[playerY-1][playerX], realMap[playerY-1][playerX+1], realMap[playerY-1][playerX+2]
    clone[playerY][playerX-2], clone[playerY][playerX-1], clone[playerY][playerX], clone[playerY][playerX+1], clone[playerY][playerX+2] = realMap[playerY][playerX-2], realMap[playerY][playerX-1], realMap[playerY][playerX], realMap[playerY][playerX+1], realMap[playerY][playerX+2]
    clone[playerY+1][playerX-2], clone[playerY+1][playerX-1], clone[playerY+1][playerX], clone[playerY+1][playerX+1], clone[playerY+1][playerX+2] = realMap[playerY+1][playerX-2], realMap[playerY+1][playerX-1], realMap[playerY+1][playerX], realMap[playerY+1][playerX+1], realMap[playerY+1][playerX+2]
    clone[playerY+2][playerX-1], clone[playerY+2][playerX], clone[playerY+2][playerX+1] = realMap[playerY+2][playerX-1], realMap[playerY+2][playerX], realMap[playerY+2][playerX+1]
    if spyglass then
        clone[playerY-3][playerX] = realMap[playerY-3][playerX]
        clone[playerY+3][playerX] = realMap[playerY+3][playerX]
        clone[playerY][playerX-3] = realMap[playerY][playerX-3]
        clone[playerY][playerX+3] = realMap[playerY][playerX+3]
        clone[playerY-2][playerX-2], clone[playerY+2][playerX-2], clone[playerY+2][playerX+2], clone[playerY-2][playerX+2] = realMap[playerY-2][playerX-2], realMap[playerY+2][playerX-2], realMap[playerY+2][playerX+2], realMap[playerY-2][playerX+2]
    end
    printGrid(clone) 
end

function revealSpyglass(mistMap, realMap, posX, posY)
    local clone = deepcopy(mistMap)
    local playerX = deepcopy(posX)
    local playerY = deepcopy(posY)
    -- Edge Detection
    -- Fog Generation
    for i = 1, 20 do
        for j = 1, 20 do
            if clone[i][j] == "[ ]" then clone[i][j] = "{▉}" end
        end
    end
    -- Clears the Fog
    clone[playerY-2][playerX-1], clone[playerY-2][playerX], clone[playerY-2][playerX+1] = realMap[playerY-2][playerX-1], realMap[playerY-2][playerX], realMap[playerY-2][playerX+1]
    clone[playerY-1][playerX-2], clone[playerY-1][playerX-1], clone[playerY-1][playerX], clone[playerY-1][playerX+1], clone[playerY-1][playerX+2] = realMap[playerY-1][playerX-2], realMap[playerY-1][playerX-1], realMap[playerY-1][playerX], realMap[playerY-1][playerX+1], realMap[playerY-1][playerX+2]
    clone[playerY][playerX-2], clone[playerY][playerX-1], clone[playerY][playerX], clone[playerY][playerX+1], clone[playerY][playerX+2] = realMap[playerY][playerX-2], realMap[playerY][playerX-1], realMap[playerY][playerX], realMap[playerY][playerX+1], realMap[playerY][playerX+2]
    clone[playerY+1][playerX-2], clone[playerY+1][playerX-1], clone[playerY+1][playerX], clone[playerY+1][playerX+1], clone[playerY+1][playerX+2] = realMap[playerY+1][playerX-2], realMap[playerY+1][playerX-1], realMap[playerY+1][playerX], realMap[playerY+1][playerX+1], realMap[playerY+1][playerX+2]
    clone[playerY+2][playerX-1], clone[playerY+2][playerX], clone[playerY+2][playerX+1] = realMap[playerY+2][playerX-1], realMap[playerY+2][playerX], realMap[playerY+2][playerX+1]
    printGrid(clone)
end

function trader()
    repeat
        print("A trader comes up to you... You have ".. money .." gold pieces")
        print("You can buy or sell any material here [L-leave]:")
        buyOrSell = string.upper(io.read())
        item = string.upper(io.read())
        if buyOrSell == "BUY" then 
            if containsKey(priceDictionary, item) then
                if money >= priceDictionary[item] then
                    money = money - priceDictionary[item] - 1
                    print("You bought ".. item .." for ".. priceDictionary[item] + 1 .." gold.")
                materialDictionary[item] = materialDictionary[item] + 1
                else print("You don't have enough money!") end
            end
            c1 = true
        end
        if buyOrSell == "SELL" then
            if containsKey(priceDictionary, item) then
                if materialDictionary[item] >= 1 then
                    money = money + priceDictionary[item]
                    print("You sold ".. item .." for ".. priceDictionary[item].." gold.")
                    materialDictionary[item] = materialDictionary[item] - 1
                else print("You don't have enough items!") end
            end
            c1 = true
        end
        if buyOrSell == "L" then c1 = true end
    until c1
end

board = {"[ ]", "[ ]", "[ ]",
         "[ ]", "[ ]", "[ ]",
         "[ ]", "[ ]", "[ ]"}

board2 = {"[ ]", "[ ]", "[ ]", "[ ]", "[ ]",
          "[ ]", "[O]", "[O]", "[O]", "[ ]",
          "[O]", "[O]", "[O]", "[O]", "[O]",
          "[ ]", "[O]", "[ ]", "[O]", "[ ]",
          "[ ]", "[ ]", "[ ]", "[ ]", "[ ]"}

-- Prints the grid
function printGrid2(grid, size)
    for i = 1, (size * size) do
        io.write(grid[i] .. " ")
        if (i % size) == 0 then
            print()
        end
    end
end

function placeMove(grid, coordinate, replaced)
    grid[coordinate] = replaced
    return grid
end

occurence = 1
luck = 2
-- Interacts with the environment and structures
function interact(realMap, pX, pY)
    structure = realMap[pY][pX]
    if occurence == 4 then occurence = 1 else occurence = occurence + 1 end
    if luck == 5 then luck = 1 else luck = luck + 1 end
    -- Plains
    if structure == "[ ]" then
        if occurence == 1 then 
            print("You cut down an apple tree! [+1 Apple, +1 Oak Log]")
            materialDictionary["APPLES"] = materialDictionary["APPLES"] + 1
            materialDictionary["LOGS"] = materialDictionary["LOGS"] + 1
        elseif occurence == 2 then 
            print("You killed a pig, but it did some damage to you! [+1 Meat, -Health]")
            materialDictionary["MEAT"] = materialDictionary["MEAT"] + 1
            if damage <= 16 then health = health - 15 + damage else health = health - 1 end
        elseif occurence == 3 then
            trader()
        else print("You look around and see nothing...") end
    end
    -- Forest
    if structure == "[F]" then
        if occurence == 1 or occurence == 3 then
            print("You cut down a spruce tree! [+2 Spruce Logs]")
            materialDictionary["LOGS"] = materialDictionary["LOGS"] + 2
        elseif occurence == 4 then
            print("A giant tarantula appears in the bushes! Fight or Flight?")
            repeat
                c2 = false
                fightOrFlight = string.upper(io.read())
                if fightOrFlight == "FIGHT" then
                    print("You just about manage to kill it, but you have received a serious wound [+4 String, -Health]")
                    if damage <= 20 then health = health - 45 + damage * 2 else health = health - 5 end
                    materialDictionary["STRING"] = materialDictionary["STRING"] + 4
                    c2 = true
                end
                if fightOrFlight == "FLIGHT" then
                    print("You barely escape the spider's fangs, but you have exhausted a lot of energy")
                    energy = energy - 5
                    c2 = true
                end
            until c2
        else print("You keep wandering through the woods...") end
    end
    -- Boat Dock
    if structure == "[B]" then
        print("Hey you there!\", a friendly man shouts.\"Do you want to buy a boat?\"")
        print("A [Row]ing Boat (8 Mile Travel Max) costs 5 gold, a [Sail]ing boat (16 Mile Travel Max) costs 15 gold [L-leave]")
        repeat
            c3 = false
            boat = string.upper(io.read())
            if boat == "ROW" then
                if money >= 5 then 
                    boatTime = 8 + sailingSkill
                    money = money - 5
                    print("You now have ".. boatTime .." miles of travel in a boat.")
                    c3 = true
                else 
                    print("You don't have enough money!")
                    c3 = true
                end
            end
            if boat == "SAIL" then
                if money >= 15 then
                    boatTime = 16 + sailingSkill 
                    money = money - 15
                    print("You now have ".. boatTime .." miles of travel in a boat.")
                    c3 = true
                else 
                    print("You don't have enough money!")
                    c3 = true
                end
            end
            if boat == "L" then c3 = true end
        until c3
    end
    -- Sea
    if structure == "[W]" then
        if occurence == 1 or occurence == 3 then
            print("You spot some fish in the water! Should you use your [fishing] rod? [L-leave]")
            fishing = string.upper(io.read())
            repeat
                c4 = false
                if fishing == "FISHING" then
                    if luck == 1 or luck == 3 or luck == 5 then
                        print("You caught the fish! [+1 Fish]")
                        materialDictionary["FISH"] = materialDictionary["FISH"] + 1
                    else 
                        print("It escaped your hook!") 
                        c4 = true
                    end
                end
                if fishing == "L" then c4 = true end
            until c4
        else
            print("The waters seem clear today...")
        end
    end
    -- Desert
    if structure == "[D]" then
        if occurence == 1 then
            print("Night falls over the desert... You see a group of zombies appearing over a sand dune. Fight or Flight? [L-leave]")
            repeat
                c5 = false
                zombie = string.upper(io.read())
                if zombie == "FIGHT" then
                    print("A zombie savagely punches you, but you manage to slay them [+3 Leather, -Health]")
                    if damage <= 15 then health = health - 35 + damage * 2 else health = health - 5 end
                    materialDictionary["LEATHER"] = materialDictionary["LEATHER"] + 3
                    c5 = true
                end
                if zombie == "FLIGHT" then
                    print("It doesn't take too much energy running away from them...")
                    energy = energy - 1
                    c5 = true
                end
            until c5       
        elseif occurence == 2 or occurence == 4 then
            print("You find an oasis... [+Health, +Energy]")
            energy = energy + 1
            health = health + 1
        else
            print("The heat is unbearable... [-Health, -Energy]")
            energy = energy - 1
            health = health - 1
        end
    end
    -- Train Tracks
    if structure == "[T]" then
        if occurence == 2 or occurence == 4 then print("You've found a railway line from East to North, but it doesn't look like its been used recently...") end
        if occurence == 1 or occurence == 3 then
            print("You find some herbs growing under the tracks [+1 Vegetable]")
            materialDictionary["VEGETABlES"] = materialDictionary["VEGETABLES"] + 3
        end
    end
    -- Kraken
    if structure == "[K]" then
        print("In the horizon you see a primordial monster devouring sharks and whales... Fight or Flight?")
        repeat
            c6 = false
            lastChance = string.upper(io.read())
            if lastChance == "FLIGHT" then c6 = true end
            t1, t2, t3, t4, t5, t6, k = 30, 30, 30, 30, 30, 30, 150
            print("The Kraken bears down on you with 6 tentacles - should you attack the [t]entacles or the [k]raken?")
            while k > 0 and health > 0 do
                attack = string.upper(io.read())
                krakenDamage = 3
                if t1 > 0 then krakenDamage = krakenDamage + 2 end
                if t2 > 0 then krakenDamage = krakenDamage + 2 end
                if t3 > 0 then krakenDamage = krakenDamage + 2 end
                if t4 > 0 then krakenDamage = krakenDamage + 2 end
                if t5 > 0 then krakenDamage = krakenDamage + 2 end
                if t6 > 0 then krakenDamage = krakenDamage + 2 end
                if attack == "K" then 
                    k = k - damage
                    print("The Kraken has ".. k .." health left!")
                elseif attack == "T" then
                    if t1 > 0 then t1 = t1 - damage 
                    elseif t2 > 0 then t2 = t2 - damage 
                    elseif t3 > 0 then t3 = t3 - damage 
                    elseif t4 > 0 then t4 = t4 - damage 
                    elseif t5 > 0 then t5 = t5 - damage 
                    elseif t6 > 0 then t6 = t6 - damage 
                    else 
                        k = k - damage 
                        print("The Kraken has ".. k .." health left!")
                    end
                    print("Tentacles Health:", t1, t2, t3, t4, t5, t6)
                else 
                    k = k - damage
                    print("The Kraken has ".. k .." health left!")
                end
                health = health - krakenDamage
                print("You have ".. health .." health left!")
                if k > 0 then print("The Kraken is still alive...") end
            end
            if health <= 0 then print("You died to the Kraken...") end
            if k <= 0 then
                print("You killed the Kraken and gained 1 Kraken Scale!")
                krakenScales = krakenScales + 1
                Real[pY][pX] = "[X]"
            end
            c6 = true
        until c6
    end
    -- Dead Kraken
    if structure == "[X]" then print("The Sea Monster has already been defeated...") end
    -- Shipwreck
    if structure == "[S]" then 
        if occurence == 1 or occurence == 3 then
            print("You discover some gold hidden in the shipwreck! [+5 Gold]")
            money = money + 5
        else
            print("You run out of oxygen while exploring the shipwreck! [-Health]")
            health = health - 5
        end
    end
    -- Lighthouse
    if structure == "[L]" then
        print("You there! Do you want to upgrade your Sailing Skill? [Yes/No]")
        sailing = string.upper(io.read())
        if sailing == "YES" then
            print("Bring me 5 Fish to upgrade 1 Level up to 4! [give]")
            skill = string.upper(io.read())
            if skill == "GIVE" then
                if materialDictionary["FISH"] >= 5 then
                    if sailingSkill < 4 then
                        print("You gave 5 fish for 1 Sailing Skill!")
                        materialDictionary["FISH"] = materialDictionary["FISH"] - 5
                        sailingSkill = sailingSkill + 1
                    else print("You are already max Sailing Skill!") end
                else print("You don't have enough fish!") end
            end
        end
    end
    -- Ravine
    if structure == "[R]" then 
        if occurence == 1 then
            print("A bat dripping with blood appears out of the shadows! Fight or Flight?")
            repeat
                c7 = false
                bat = string.upper(io.read())
                if bat == "FIGHT" then
                    print("The bat bites your arm, but you manage to slay it [+1 Meat, +1 String, -Health]")
                    if damage <= 15 then health = health - 35 + damage * 2 else health = health - 5 end
                    materialDictionary["MEAT"] = materialDictionary["MEAT"] + 1
                    materialDictionary["STRING"] = materialDictionary["STRING"] + 1
                    c7 = true
                end
                if bat == "FLIGHT" then
                    print("The bat bites you on your attempt to flee! [-Health]")
                    health = health - 1
                    c7 = true
                end
            until c7   
        elseif occurence == 2 then
            print("You find a piece of iron in an abandoned cart... [+1 Iron]")
            materialDictionary["IRON"] = materialDictionary["IRON"] + 1
        elseif occurence == 3 then
            print("You can barely see anything in this pitch black ravine... [+1 STONES]")
            materialDictionary["STONES"] = materialDictionary["STONES"] + 1
        else 
            print("A Rat jumps out of the darkness and bites your foot! [-Health]")
            health = health - 1
        end
    end
    -- Mountain
    if structure == "[M]" then
        if occurence == 1 or occurence == 3 then
            print("A bear appears behind a tree! Fight or Flight?")
            repeat
                c8 = false
                bear = string.upper(io.read())
                if bear == "FIGHT" then
                    if luck == 1 or luck == 3 or luck == 5 then
                        print("You manage to kill it without any harm!")
                    else
                        print("You take some serious damage from the bear!")
                        health = health - 5
                    end
                    print("You scavenge some meat from the kill!")
                    materialDictionary["MEAT"] = materialDictionary["MEAT"] + 2
                    c8 = true
                end
                if bear == "FLIGHT" then
                    print("You hid in the bushes... the bear couldn't find you...")
                    energy = energy - 1
                    c8 =  true
                end
            until c8
        elseif occurence == 2 then
            print("You find some herbs growing beside a tree [+1 VEGETABLE]")
            materialDictionary["VEGETABLES"] = materialDictionary["VEGETABLES"] + 1
        else
            print("It's cold up here...")
            if not beaverFurTunic then
                health = health - 2
            end
        end               
    end
    -- Engineer
    if structure == "[E]" then
        if stage < 5 then print("\"Hi!\", a voice shouts from the wreckage. \"Can you help me fix this?\"") end
        c9 = false
        if stage == 1 then
            print("To fix the railway I firstly need 5 logs to construct the frame [Give/L]")
            repeat 
                railway = string.upper(io.read())
                if railway == "GIVE" then
                    if materialDictionary["LOGS"] >= 5 then
                        print("Thank you for the help!")
                        materialDictionary["LOGS"] = materialDictionary["LOGS"] - 5
                        stage = stage + 1
                    else print("You don't have enough resources!") end
                    c9 = true
                end
                if railway == "L" then c9 = true end
            until c9
        end
        if stage == 2 then
            print("To fix the railway I now need 5 iron to construct the rails [Give/L]")
            repeat 
                railway = string.upper(io.read())
                if railway == "GIVE" then
                    if materialDictionary["IRON"] >= 5 then
                        print("Thank you for the help!")
                        materialDictionary["IRON"] = materialDictionary["IRON"] - 5
                        stage = stage + 1
                    else print("You don't have enough resources!") end
                    c9 = true
                end
                if railway == "L" then c9 = true end
            until c9
        end
        if stage == 3 then
            print("To fix the railway I now need 5 stones to construct the frame [Give/L]")
            repeat 
                railway = string.upper(io.read())
                if railway == "GIVE" then
                    if materialDictionary["STONES"] >= 5 then
                        print("Thank you for the help!")
                        materialDictionary["STONES"] = materialDictionary["STONES"] - 5
                        stage = stage + 1
                    else print("You don't have enough resources!") end
                    c9 = true
                end
                if railway == "L" then c9 = true end
            until c9
        end
        if stage == 4 then
            print("To finish fixing the railway I need 5 string [Give/L]")
            repeat 
                railway = string.upper(io.read())
                if railway == "GIVE" then
                    if materialDictionary["STRING"] >= 5 then
                        print("Thank you for the help!")
                        materialDictionary["STRING"] = materialDictionary["STRING"] - 5
                        stage = stage + 1
                    else print("You don't have enough resources!") end
                    c9 = true
                end
                if railway == "L" then c9 = true end
            until c9
        end
        if stage == 5 then
            repeat 
                print("The railway is now fixed! You can now travel to any train track from here in an instant! [e.g 11, 6] [e.g 1, 11] [e.g 18, 19] [L-leave]")
                input_string = io.read()
                if input_string == "l" or input_string == "L" then c9 = true end
                if input_string ~= "l" and input_string ~= "L" then
                    local num1, num2 = string.match(input_string, "(%d+),%s*(%d+)")
                    num1 = tonumber(num1)
                    num2 = tonumber(num2)
                    if Real[num2][num1] == "[T]" then
                        X, Y = num1, num2
                        print("Seatbelts on!")
                        c9 = true
                    else 
                        print("That isn't a train track!")
                        c9 = true
                    end
                end
            until c9
        end
    end
    -- Peak
    if structure == "[P]" then
        if beaverFurTunic then
            print("A hurricane of snow appears up ahead. Something unnatural is here. Fight or Flight?")
            c10 = false
            repeat
                lastChance = string.upper(io.read())
                if lastChance == "FLIGHT" then c10 = true end
                w, r1, r2, r3 = 480, 40, 20, 10
                W, R1, R2, R3 = 10, 1, 2, 4
                meteor, meteor1 = 3, 5
                while health > 0 do
                    -- First Phase
                    print("A Wizard appears out of the storm! He has 3 replicas surrounding him! [1, 2, 3] (40HP 1ATT, 20HP, 2ATT, 10HP, 4ATT)")
                    while w > 320 do
                        if health <= 0 then break end
                        replica = io.read()
                        if replica == "1" then r1 = r1 - damage end
                        if replica == "2" then r2 = r2 - damage end
                        if replica == "3" then r3 = r3 - damage end
                        if r1 <= 0 then r1, R1 = 0, 0 end
                        if r2 <= 0 then r2, R2 = 0, 0 end
                        if r3 <= 0 then r3, R3 = 0, 0 end
                        print("The replicas have "..r1.." "..r2.." "..r3.." health left!")
                        health = health - (W + R1 + R2 + R3)
                        print("You have ".. health .." health remaining!")
                        if r1 == 0 and r2 == 0 and r3 == 0 then
                            print("You killed all the replicas! Strike the wizard to break his shield! [X]")
                            c11 = false
                            repeat
                                wiz = string.upper(io.read())
                                if wiz == "X" then
                                    print("You struck the wizard, but he is still alive!")
                                    print("The wizard has 320 health remaining!")
                                    w = 320
                                    c11 = true
                                end
                            until c11
                        end
                    end
                    printGrid2(board, 3)
                    while w > 160 do
                        print("The wizard flies up in the air and casts meteors")
                        print("Pick a spot to dodge the meteor! [1-9]")
                        spot = tonumber(io.read())
                        meteorBoard = deepcopy(board)
                        meteorBoard = placeMove(meteorBoard, spot, "[X]")
                        printGrid2(meteorBoard, 3)
                        occurence = occurence + 1
                        luck = luck + 1
                        if occurence == 5 then occurence = 1 end
                        if luck == 6 then luck = 1 end
                        wzrd = occurence + luck
                        print("The wizard hit tile ".. wzrd .."")
                        if wzrd == spot then
                            meteor = meteor - 1
                            print("The wizard hit your position!")
                        else print("You survived the blast")
                        meteorBoard = deepcopy(board)
                        meteorBoard = placeMove(meteorBoard, spot, "[O]")
                        print("You can still be hit ".. meteor .." times!")
                        end
                        meteor1 = meteor1 - 1
                        if meteor == 0 then 
                            print("You died to the wizard!")
                            health = 0
                            break
                        elseif meteor1 == 0 then
                            print("The wizard ran out of mana! He falls to the floor. Strike the wizard to break his shield! [X]")
                            c12 = false
                            repeat
                                wiz = string.upper(io.read())
                                if wiz == "X" then
                                    print("You struck the wizard, but he is still alive!")
                                    print("The wizard has 160 health remaining!")
                                    w = 160
                                    c12 = true
                                end
                            until c12
                        end
                    end 
                    while w > 0 do
                        print("The wizard only has his staff to defend him [X]")
                        c13 = false
                        repeat 
                            finalPhase = string.upper(io.read())
                            if finalPhase == "X" then
                                w = w - damage
                                health = health - 5
                                print("The wizard has ".. w .." health remaining!")
                                print("You have ".. health .." health remaining!")
                                c13 = true
                            end
                        until c13
                        if health <= 0 then break end
                    end
                    if w <= 0 then break end               
                end
                if health <= 0 then
                    print("You died to the wizard!")
                    break
                end
                print("You killed the wizard!")
                print("You have gained the spyglass [+1 Fog Distance]")
                spyglass = true
                Real[pY][pX] = "[Z]"
                c10 = true
            until c10
        else print("It is too cold up here!") end
    end
    -- Vanquished Wizard
    if structure == "[Z]" then print("The Wizard has already been vanquished!") end
    -- Altar
    if structure == "[A]" then
        print("Offer up 5 Logs, 5 Stones, 5 Meat and 5 Vegetables to the Gods [Give/L]")
        offering = string.upper(io.read())
        if offering == "GIVE" then
            if materialDictionary["LOGS"] >= 5 and materialDictionary["STONES"] >= 5 and materialDictionary["MEAT"] >= 5 and materialDictionary["VEGETABLES"] >= 5 then 
                materialDictionary["LOGS"] = materialDictionary["LOGS"] - 5
                materialDictionary["STONES"] = materialDictionary["STONES"] - 5
                materialDictionary["MEAT"] = materialDictionary["MEAT"] - 5
                materialDictionary["VEGETABLES"] = materialDictionary["VEGETABLES"] - 5
                if luck == 1 or luck == 3 or luck == 5 then
                    print("You have been cleansed of evil and you have been rewarded 35 gold")
                    money = money + 35
                    health = deepcopy(maxHealth)
                    energy = deepcopy(maxEnergy)
                else 
                    print("The offering didn't go as planned! The Gods have sent down a demon to the Altar!")
                    print("[ATTACK / BlOCK / DODGE]")
                    demon = 200
                    demonWeakness = 0
                    while demon > 0 and health > 0 do
                        -- Your attack
                        occurence = occurence + 1
                        if occurence >= 5 then occurence = 1 end
                        demonAttack = true
                        combat = string.upper(io.read())
                        if combat == "ATTACK" then
                            if occurence == 1 or occurence == 4 then
                                print("You slashed the demon across the chest, dealing massive damage")
                                demon = demon - damage - 5 - demonWeakness
                            elseif occurence == 2 then
                                print("The demon dodged most of your attack, but you still drew some blood!")
                                demon = demon - damage + 5 - demonWeakness
                            else
                                print("The demon barely blocked your attack!")
                                demon = demon - damage - demonWeakness
                                health = health - 5
                            end
                        end
                        demonWeakness = 0
                        if combat == "BLOCK" then
                            if occurence == 2 or occurence == 4 then 
                                print("You got a perfect parry! The demon can no longer attack and you do 10 more damage on your next hit")
                                demonWeakness = 10
                                demonAttack = false
                            else
                                print("You blocked the attack, but some still got through!")
                                health = health + 10
                            end
                        end
                        if combat == "DODGE" then
                            if occurence == 2 or occurence == 3 then
                                print("You dodged the attack perfectly! The demon can no longer attack and you do 4-16 more damage on your next hit")
                                demonWeakness = occurence * 4
                                demonAttack = false
                            else
                                print("You barely dodged the attack")
                                health = health + 10
                            end
                        end
                        -- Demon Attack
                        if demonAttack then
                            if occurence == 2 or occurence == 4 then 
                                print("The demon's claws raked your body!")
                                health = health - 35
                            else
                                print("The demon drew a bit of blood!")
                                health = health - 25
                            end
                        end
                        print("You have ".. health .. " health left! The demon has ".. demon .. " health left!")
                    end            
                    if demon < 0 then        
                        print("You killed the demon!")
                        if damage >= 20 and damage < 25 then
                            print("You equipped the Demon's Claws")
                            damage = 25
                            inventoryDictionary["Weapon"] = "Demon's Claws"
                        else
                            print("You have been rewarded with 50 Gold!")
                            money = money + 50
                        end
                    end
                    if health < 0 then
                        print("The demon killed you...")
                    end
                end
            else
                print("You don't have enough materials!")
            end
        else
            print("You left the Altar...")
        end
    end
    -- Haverstead
    if structure == "[H]" then
        print("hi")
    end
    -- Castle
    if structure == "[C]" then
        print("hi")
    end
    -- Nyxeria
    if structure == "[N]" then
        print("hi")
    end
    -- Orc Camp
    if structure == "[O]" then
        print("\"Soldier!\", a voice shouts in the distance. \"Do you want to help us with our siege of the Orc Camp?\" [Yes/No] ")
        orc = string.upper(io.read())
        if orc == "YES" then
            repeat
                print("Excellent! Aim the catapult! [Hit all O, e.g 3 3]")
                printGrid2(board2, 5)
                a,b = io.read("*n","*n")
                coordinate = b * 5 + a - 5
                if board2[coordinate] == "[O]" then
                    print("You hit the Orc Camp")
                    board2[coordinate] = "[X]"
                else 
                    print("You missed!")
                end
                camp = countOccurrencesList(board2, "[O]")
                print("The Orc Camp is still standing!")
            until camp == 0
            print("There are still some Orcs standing! [X]")
            orcsLeft = 3
            repeat
                attack = string.upper(io.read())
                if attack == "X" then
                    print("You killed an Orc!")
                    health = health - 10
                    orcsLeft = orcsLeft - 1
                    print("There are ".. orcsLeft .." Orcs left! You have ".. health .." health left!")
                    if health <= 0 then
                        print("You died to the Orcs!")
                        break
                    end
                end
            until orcsLeft == 0
            if health > 0 then
                print("The siege is successful!")
                for k, _ in pairs(materialDictionary) do
                    materialDictionary[k] = materialDictionary[k] + 1
                end
            end
        end
    end
    -- Volcano
    if structure == "[V]" then
        print("hi")
    end
end


structureDictionary = {
    ["[ ]"] = "Plains",
    ["[F]"] = "Forest",
    ["[W]"] = "Sea",
    ["[D]"] = "Desert",
    ["[T]"] = "Train Tracks",
    ["[B]"] = "Boat Docks",
    ["[K]"] = "Kraken",
    ["[S]"] = "Shipwreck",
    ["[M]"] = "Mountain",
    ["[P]"] = "Peak",
    ["[A]"] = "Altar",
    ["[H]"] = "Haverstead",
    ["[C]"] = "Castle",
    ["[N]"] = "Nyxeria",
    ["[R]"] = "Ravine",
    ["[E]"] = "Engineer",
    ["[O]"] = "Orc Camp",
    ["[L]"] = "Lighthouse",
    ["[V]"] = "Volcano",
    ["[X]"] = "Dead Kraken",
    ["[Z]"] = "Vanquished Wizard"}

inventoryDictionary = {
    ["Helmet"] = "Wool Scarf [5 Health]",
    ["Chestplate"] = "Worn Tunic [5 Health]",
    ["Greaves"] = "Leather Trousers [5 Health]",
    ["Weapon"] = "Fists"}

foodDictionary = {
    ["MEAL1"] = "",
    ["MEAL2"] = "",
    ["MEAL3"] = "",
    ["MEAL4"] = "",
    ["MEAL5"] = ""}

materialDictionary = {
    ["LOGS"] = 5,
    ["STONES"] = 5,
    ["LEATHER"] = 0,
    ["IRON"] = 0,
    ["STRING"] = 0,
    ["ARROWS"] = 0,
    ["WATER"] = 0,
    ["APPLES"] = 0,
    ["MEAT"] = 5,
    ["FISH"] = 0,
    ["VEGETABLES"] = 5}

priceDictionary = {
    ["APPLES"] = 1,
    ["MEAT"] = 3,
    ["FISH"] = 2,
    ["VEGETABLES"] = 1,
    ["LOGS"] = 1,
    ["STONES"] = 1,
    ["LEATHER"] = 1,
    ["IRON"] = 2,
    ["STRING"] = 1}

orderedKeys = {"Helmet", "Chestplate", "Greaves", "Weapon"}
orderedKeys2 = {"MEAL1", "MEAL2", "MEAL3", "MEAL4", "MEAL5"}
orderedKeys3 = {"LOGS", "STONES", "LEATHER", "IRON", "STRING", "ARROWS", "WATER", "APPLES", "MEAT", "FISH", "VEGETABLES"}

-- Main Loop
print("Press P to Play")
P = string.upper(io.read())
if P == "P" then
    X, Y = 4, 15
    revealGrid(Mist, Real, X, Y)
    maxEnergy, energy, maxHealth, health, damage, boatTime, money, sailingSkill, krakenScales, beaverFurTunic, stage, spyglass = 1000, 1000, 1000, 70, 30, 0, 1000, 0, 0, true, 1, false
    print("You spawn in a strange world with fog around you...")
    option = ""
    while option ~= "X" and energy > 0 and health > 0 do
        if boatTime == 0 and (Real[Y][X] == "[W]" or Real[Y][X] == "[K]" or Real[Y][X] == "[S]" or Real[Y][X] == "[X]") then break end
        if Real[Y][X] == "[W]" or Real[Y][X] == "[K]" or Real[Y][X] == "[S]" or Real[Y][X] == "[X]" then boatTime = boatTime - 1 end
        print("You are at (" .. X .. "," .. Y .. ") [".. structureDictionary[Real[Y][X]].."] Energy: ".. energy ..", Health: ".. health..", Money: ".. money .."")
        print("W-forward, A-left, S-back, D-right, I-interact, E-inventory, M-Materials, F-Food, X-quit")
        option = string.upper(io.read())
        energy = energy - 1
        if option == "W" then Y = Y - 1 end
        if option == "A" then X = X - 1 end
        if option == "S" then Y = Y + 1 end
        if option == "D" then X = X + 1 end 
        if X <= 1 then X = 1 end
        if X >= 20 then X = 20 end
        if Y <= 1 then Y = 1 end
        if Y >= 20 then Y = 20 end
        revealGrid(Mist, Real, X, Y)
        if option == "E" then
            printInventory(inventoryDictionary, orderedKeys)
        end
        if option == "M" then
            printInventory(materialDictionary, orderedKeys3)
        end
        if option == "F" then
            printInventory(foodDictionary, orderedKeys2)
        end
        if option == "I" then
            interact(Real, X, Y)
        end
    end
end

